import { readFileSync } from 'fs';
import path from 'path';

import { CompleteChainMap, ContractVerifier } from '@abacus-network/sdk';
import { CompilerOptions } from '@abacus-network/sdk/dist/deploy/verify/types';

import { fetchGCPSecret } from '../src/utils/gcloud';
import { readJSON } from '../src/utils/utils';

import {
  getCoreEnvironmentConfig,
  getCoreVerificationDirectory,
  getEnvironment,
} from './utils';

async function main() {
  const environment = await getEnvironment();
  const config = getCoreEnvironmentConfig(environment) as any;
  const multiProvider = await config.getMultiProvider();

  const verification = readJSON(
    getCoreVerificationDirectory(environment),
    'verification.json',
  );

  // generated by `yarn hardhat flatten` in solidity/core
  const flattenedSource = readFileSync(
    path.join(getCoreVerificationDirectory(environment), 'flattened.sol'),
    { encoding: 'utf8' },
  );

  // from solidity/core/hardhat.config.ts
  const compilerOptions: CompilerOptions = {
    codeformat: 'solidity-single-file',
    compilerversion: 'v0.8.13+commit.abaa5c0e',
    optimizationUsed: '1',
    runs: '999999',
  };

  const apiKeys: CompleteChainMap<string> = await fetchGCPSecret(
    'explorer-api-keys',
    true,
  );

  const verifier = new ContractVerifier(
    verification,
    multiProvider,
    apiKeys,
    flattenedSource,
    compilerOptions,
  );

  await verifier.verify();
}

main().then().catch();
